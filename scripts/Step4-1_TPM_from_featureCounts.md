# Step 4-1: TPM Calculation (Option B. Alignment-based)
This script is ONLY used when quantification was performed via STAR + featureCounts (Option B).

```
# Rscript

library(readr)
library(dplyr)

# Load featureCounts output
# gene_counts.txt: Contains annotation columns (Geneid, Chr, Start, End, Strand, Length),
# sample count columns start from column 7.
counts <- read_tsv("gene_counts.txt", comment = "#")

# Extract gene lengths (bp â†’ converted to kb in RPK calculation)
gene_lengths <- counts$Length

# Extract raw count matrix (sample columns only)
count_data <- counts[, 7:ncol(counts)]

# Calculate Reads Per Kilobase (RPK)
rpk <- sweep(count_data, 1, gene_lengths / 1000, FUN = "/")

# Calculate scaling factors (sum of all RPK values per sample)
scaling_factors <- colSums(rpk)

# Calculate Transcripts Per Million (TPM)
tpm <- sweep(rpk, 2, scaling_factors / 1e6, FUN = "/")

# Combine Gene IDs with TPM matrix
tpm <- cbind(Geneid = counts$Geneid, tpm)

# Save TPM matrix
# Output file: tpm_matrix.txt
write_tsv(tpm, "tpm_matrix.txt")

```

## Code Explanation
- gene_counts.txt: Output file generated by featureCounts (Step3B-2).
It contains annotation columns (Geneid, Chr, Start, End, Strand, Length) followed by per-sample counts (from column 7 onward).
```
# Example of gene_counts.txt (featureCounts output)

Geneid   Chr   Start   End   Strand   Length   Sample1   Sample2
ENSG000001   1     11869   14409   +        1541     100       150
ENSG000002   1     14404   29570   -        2000     200       300
```
